#!/bin/bash

# Simple Tasks Manager, yay!

# Copyright (C) 2010 Jose E. Marchesi

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

## Configuration ##
#
# This section contains variables that can be tweaked by the user to
# adapt the behavior of tasktool.

# File containing the tasks database.
tt_db=TODO

# Tasktool depends on the GNU record utilities to work.  If they are
# not installed in your system please get them from
# ftp://ftp.gnu.org/gnu/recutils
#
# The following variables contain the names of the recutils that will
# be used by the script.

tt_recsel=recsel
tt_recins=recins
tt_recdel=recdel
tt_recset=recset
tt_recfix=recfix
tt_recinf=recinf

## Internal Variables ##
#
# The user don't want to touch them.

tt_tasktool=tasktool
tt_version="0.1"
tt_copyright_holder="Jose E. Marchesi"
tt_copyright_years="2010"
tt_db_template="\
# -*- mode: rec -*-
#
# TODO file for the GNU recutils.

%rec: Issue
%key: Id
%type: Summary line
%mandatory: Summary
# %type: Type enum improvement bug
# %type: State enum open closed
# %type: Originator email
# %type: Assignee email
# %type: Assigned email
%fsort: Id Summary State Originator Description
%doc:
+ An issue.  It contains, at least, the following
+ fields:
+
+ Type: the type of the issue.  An improvement or
+       a bug.
+ Originator: an email identifying the person/entity
+             that originated the issue.

# End of TODO"

# Help messages
tt_help_footer="\
Report tasktool bugs to bug-recutils@gnu.org
tasktool home page: <http://www.gnu.org/software/recutils/tasktool/>
General help using GNU software: <http://www.gnu.org/gethelp/>"

tt_help="\
Usage: $tt_tasktool [OPTION]... SUBCOMMAND [OPTION]...
Very simple tasks manager.

Mandatory arguments to long options are mandatory for short options too.
  -d, --database=FILE                 location of the database to use.  It
                                        defaults to $tt_db.                                  
      --help                          print this help message and exit.
      --version                       print a version message and exit.

$tt_tasktool supports the following sub commands.

       init                           initialize a new database in the default
                                        location.
       list                           get a list of issues.
       show                           print information about a given issue.
       create                         create a new issue.

To get detailed help on a specific sub command use '$tt_tasktool CMD
--help', like in:

       tasktool show --help

$tt_help_footer"

tt_help_init="\
Usage: $tt_tasktool init
Initialize a tasktool database.

Mandatory arguments to long options are mandatory for short options too.
      --help                          print this help message and exit.

Examples:

        tasktool -d my-database.rec init

$tt_help_footer"

tt_help_show="\
Usage: $tt_tasktool show [OPTION]... ISSUE_ID
Show information about a given issue.

Mandatory arguments to long options are mandatory for short options too.
      --help                          print this help message and exit.

Examples:

        tasktool show 203

$tt_help_footer"

tt_help_list="\
Usage: $tt_tasktool list [OPTION]...
List issues.

Mandatory arguments to long options are mandatory for short options too.
      --help                          print this help message and exit.
  -s, --state                         list issues with the given state:
                                       'closed' or 'open'.
  -o, --originator                    list issues with the given originator.

Examples:

        tasktool list
        tasktool list -s closed
        tasktool list -o jemarch@gnu.org

$tt_help_footer"

tt_help_create="\
Usage: $tt_tasktool create -t SUMMARY
Create a new issue in the database.

Mandatory arguments to long options are mandatory for short options too.
  -s, --summary=STR                   summary for the new issue.  This option is
                                        mandatory.
  -o, --originator=EMAIL              originator of the Issue.  An email.
  -i, --id=NUMBER                     the ID of the new issue.  If this option is not
                                        used then an ID is created for the new issue.
      --help                          print this help message and exit.

Examples:

        tasktool create \"The function 'parse_field_name' is buggy.\"

$tt_help_footer"

# Version message
tt_version="\
$tt_tasktool $tt_version
Copyright (C) $tt_copyright_years $tt_copyright_holder
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law."

## Recutils Interface ##

# Check the availability of the GNU recutils.  If they are not found,
# notify the user and exit.
tt_rec_check_utility ()
{
    # Parameters:
    # $1 => The name of the utility to check.
    test "$#" -gt "0" && {
        ${1} --version 2>&1 > /dev/null < /dev/null || tt_error "$1 not found"
    }
}

tt_rec_check_utilities ()
{
    for u in $tt_recinf \
             $tt_recfix \
             $tt_recsel \
             $tt_recins \
             $tt_recdel \
             $tt_recset
    do
        tt_rec_check_utility $u
    done
}

## DB Interface ##
#
# Accessing the tasks database.

# Test whether the database can be read and is correct.
tt_db_check ()
{
    test -f ${tt_db} || \
        {
           tt_error "cannot open database in $tt_db.  Use 'init' to create one."
        }

    recfix ${tt_db}
    if test "$?" != "0"
    then
        tt_error "data integrity problem in ${tt_cb}.  See the errors above."
        exit 1
    fi
}

# Create a new, empty database.
tt_db_create ()
{
    test -f ${tt_db} && {
        tt_error "database already exists in $tt_db."
        return
    }

    echo "$tt_db_template" > ${tt_db}
    echo "$tt_tasktool: database initialized in ${tt_db}."
}

# Test whether a task with the given ID exists in the database.
#
# Parameters:
# $1 => Id of a task.
tt_db_task_p ()
{
    COUNT=`${tt_recsel} -t Issue -e "Id = '$1'" -c ${tt_db}`
    if test "$COUNT" -gt "0"
    then
        return 0
    fi

    return 1
}

# Show a given issue
# Parameters:
# $1 => Id of the task to show.
tt_db_show_task ()
{
    ${tt_recsel} -t Issue -e "Id = '$1'" ${tt_db}
}

# Get a free ID for an issue.
tt_db_free_id ()
{
    max_id=0
    for id in `${tt_recsel} -t Issue -P Id ${tt_db}`
    do
        if test $id -gt $max_id
        then
            max_id=$id
        fi
    done

    echo `expr $max_id + 1`
}

## VC Interface ##
#
# Functions to interact with version control systems and hide its
# details.  Each operation OP implemented in this interface involves
# the creation of a couple of functions:
#
# tt_vc_OP
#
#    The VC-independent function.
#
# tt_vc_XXX_OP
#
#    Where XXX is the name of a supported version control system.

# Supported VCs
tt_supported_vcs="cvs git bzr"

## Utility Functions ##
#
# Misc functions used by the script.

# Print a message and exit with an error state.
tt_error ()
{
    if test "$#" -gt "0"
    then
        echo "error: $1" 2>&1
    fi
    
    exit 1
}

# Process the 'init' subcommand
tt_process_cmd_init ()
{
    TEMP=`getopt -o f:: --long help -n 'tasktool: init' -- "$@"`
    if test "$?" != "0"
    then
        exit 1
    fi
    eval set -- "$TEMP" || exit 1;

    while true
    do
        case "$1" in
            --help)
                echo "$tt_help_init"
                exit 1
                ;;
            *)
                shift
                break
                ;;
        esac
    done

    # Initialize the database
    tt_db_create
}

# Process the 'show' subcommand
tt_process_cmd_show ()
{
    TEMP=`getopt -o f: --long help -n 'tasktool: show' -- "$@"`
    if test "$?" != "0"
    then
        exit 1
    fi
    eval set -- "$TEMP" || exit 1;

    while true
    do
        case "$1" in
            --help)
                echo "$tt_help_show"
                exit 1
                ;;
            *)
                shift
                break
                ;;
        esac
    done

    # Get the ID of the task to show.
    if test "$#" != "1"
    then
        echo "$tt_help_show"
        exit 1
    fi

    # Check if a task with a given ID exists.
    tt_db_task_p "$1" || \
        { echo "$tt_tasktool: task '$1' not found."; exit 1; }
    tt_db_show_task "$1"
}

# Process the 'list' subcommand
tt_process_cmd_list ()
{
    TEMP=`getopt -o -e:s:o: --long help,state,originator -n 'tasktool: list' -- "$@"`
    if test "$?" != "0"
    then
        exit 1
    fi
    eval set -- "$TEMP" || exit 1;

    selection_expression="1"
    state=""
    originator=""
    while true
    do
        case "$1" in
            --help)
                echo "$tt_help_list"
                exit 1
                ;;
            -s|--state)
                state="$2"
                shift
                shift
                ;;
            -o|--originator)
                originator="$2"
                shift
                shift
                ;;
            *)
                shift
                break
                ;;
        esac
    done

    if test "$#" != "0"
    then
        echo "$tt_help_list"
        exit 1
    fi

    # Prepare the selection expression
    if test -n "$state"
    then
        selection_expression="$selection_expression && (State = '$state')"
    fi

    if test -n "$originator"
    then
        selection_expression="$selection_expression && (Originator = '$originator')"
    fi
    
    tasks=`${tt_recsel} -t Issue -e "$selection_expression" ${tt_db}`
    ntasks=`echo "$tasks" | ${tt_recsel} -c`
    ntask="0"
    while test "$ntask" -lt "$ntasks"
    do
        task=`echo "$tasks" | ${tt_recsel} -n $ntask`
        task_id=`echo "$task" | ${tt_recsel} -P Id`
        task_summary=`echo "$task" | ${tt_recsel} -P Summary`
        
        echo "$task_id $task_summary"

        ntask=`expr $ntask + 1`
    done
}

# Process the 'create' subcommand
tt_process_cmd_create ()
{
    TEMP=`getopt -o -s: --long help,summary: -n 'tasktool: create' -- "$@"`
    if test "$?" != "0"
    then
        exit 1
    fi
    eval set -- "$TEMP" || exit 1;

    while true
    do
        case "$1" in
            --help)
                echo "$tt_help_create"
                exit 1
                ;;
            -t|--summary)
                summary=$2
                shift
                shift
                ;;
            *)
                shift
                break
                ;;
        esac
    done

    if test "$#" != "0"
    then
        echo $*
        echo "$tt_help_create"
        exit 1
    fi

    test -n $summary || {
        tt_error "you must specify a summary for the new issue."
        exit 1
    }

    new_id=`tt_db_free_id`

    # Add the new issue to the database.
    $tt_recins -t Issue -f Id -v $new_id -f Summary -v $summary $tt_db
    echo "tasktool: issue $new_id added to $tt_db."
}

# Parse arguments and set some variables.
tt_parse_arguments ()
{
    TEMP=`getopt -o +d: --long help,database:,version -n 'tasktool' -- "$@"`
    if test "$?" != "0"
    then
        exit 1
    fi
    eval set -- "$TEMP" || exit 1;
    
    while true
    do
        case "$1" in
            --version)
                echo "$tt_version"
                shift
                break
                ;;
            init)
                shift
                tt_process_cmd_init $*
                break
                ;;
            show)
                shift
                tt_db_check
                tt_process_cmd_show $*
                break
                ;;
            list)
                shift
                tt_db_check
                tt_process_cmd_list $*
                break
                ;;
            create)
                shift
                tt_db_check
                tt_process_cmd_create $*
                break
                ;;
            -d|--database)
                tt_db="$2"
                shift; shift;
                ;;
            --)
                shift
                ;;
            --help)
                echo "$tt_help"
                exit 1
                ;;
            *)
                # Do nothing
                break;
                ;;
        esac
    done
}

## Start! ##

tt_rec_check_utilities
tt_parse_arguments $*

# End of tasktool
